
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Programming Guide &mdash; Multi-UART Module Usage v0.1 documentation</title>
    <link rel="stylesheet" href="_static/xdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://mathjax.connectmv.com/MathJax.js"></script>
    <script type="text/javascript" src="_static/xcomment.js"></script>
    <link rel="top" title="Multi-UART Module Usage v0.1 documentation" href="index.html" />
    <link rel="next" title="Example Applications" href="Example Applications.html" />
    <link rel="prev" title="Multi-UART Common API" href="API.html" /> 

<script>
function setheight() {
h1 = document.getElementById('d1').style.height;
h2 = document.getElementById('d2').style.height;

if (parseInt(h1) > parseInt(h2)) {
document.getElementById('d2').style.height=h1 + "px";
}
else {
document.getElementById('d1').style.height=h2 + "px";
}

}
</script>
</head>

<body onload="setheight();">

  

    <div class="document" id='d1'>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
<div style="float: right">
<a href="API.html"
                        title="previous chapter"> &lt&lt </a>
<a href="Example Applications.html"
                        title="next chapter"> &gt&gt </a></p>
</div>

            
  <div class="section" id="programming-guide">
<h1>Programming Guide<a class="headerlink" href="#programming-guide" title="Permalink to this headline">¶</a></h1>
<p>This section discusses the programming aspects of the Multi-UART component and typical implementation and usage of the API.</p>
<div class="section" id="structure">
<h2>Structure<a class="headerlink" href="#structure" title="Permalink to this headline">¶</a></h2>
<p>This is an overview of the key header files that are required, as well as the thread structure and information regarding the buffering provision and requirements for the component.</p>
<div class="section" id="source-code">
<h3>Source Code<a class="headerlink" href="#source-code" title="Permalink to this headline">¶</a></h3>
<p>All of the files required for operation are located in the <tt class="docutils literal"><span class="pre">module_multi_uart</span></tt> directory. The files that are need to be included for use of this component in an application are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">File</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal"><span class="pre">multi_uart_rxtx.h</span></tt></td>
<td>Header file for simplified launch of both the TX and RX server threads, also provides the headers for the individual RX and TX API interfaces.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">multi_uart_common.h</span></tt></td>
<td>Header file providing configuration ENUM definitions and other constants that may be required for operation</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">multi_uart_rx.h</span></tt></td>
<td>Header file for accessing the API of the RX UART server - included by <tt class="docutils literal"><span class="pre">multi_uart_rxtx.h</span></tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">multi_uart_tx.h</span></tt></td>
<td>Header file for accessing the API of the TX UART server - included by <tt class="docutils literal"><span class="pre">multi_uart_rxtx.h</span></tt></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="configuration-of-multi-uart-component">
<h2>Configuration of Multi-UART component<a class="headerlink" href="#configuration-of-multi-uart-component" title="Permalink to this headline">¶</a></h2>
<p>Multi-UART component configuration takes place in two domains - a static compile time configuration (discussed in this section) and a runtime dynamic configuration (as discussed in <a class="reference internal" href="#sec-initialisation"><span>Initialisation</span></a> and <a class="reference internal" href="#sec-reconf-rxtx"><span>Reconfiguration of RX &amp; TX Server</span></a>.</p>
<p>Static configuration is done by the application providing configuration header files <tt class="docutils literal"><span class="pre">multi_uart_tx_conf.h</span></tt> and <tt class="docutils literal"><span class="pre">multi_uart_rx_conf.h</span></tt>.</p>
<div class="section" id="static-configuration-of-uart-tx">
<span id="sec-tx-conf-header"></span><h3>Static configuration of UART TX<a class="headerlink" href="#static-configuration-of-uart-tx" title="Permalink to this headline">¶</a></h3>
<p>Below is a summary of the configuration options that are in the <tt class="docutils literal"><span class="pre">multi_uart_tx_conf.h</span></tt> file, their suggested defaults and an explanation of their function.</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Define</th>
<th class="head">Default</th>
<th class="head">Other options</th>
<th class="head">Explanation</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>UART_TX_USE_EXTERNAL_CLOCK</td>
<td>(None)</td>
<td>Not defined</td>
<td>The presence of this define turns on or off the requirement to use external clocking this is discussed in <a class="reference internal" href="Component Description.html#sec-ext-clk"><span>Clocking</span></a>.</td>
</tr>
<tr><td>UART_TX_CLOCK_RATE_HZ</td>
<td>1843200 | 100000000</td>
<td>Any valid clock rate</td>
<td>Defines the clock rate that the baud rates are derived from</td>
</tr>
<tr><td>UART_TX_MAX_BAUD_RATE</td>
<td>115200</td>
<td>less than or equal to 115200</td>
<td>Define the max baud rate the API will allow configuration. Validated to 115200</td>
</tr>
<tr><td>UART_TX_CLOCK_DIVIDER</td>
<td>(UART_TX_CLOCK_RATE_HZ / UART_TX_MAX_BAUD_RATE)</td>
<td>Any appropriate divider</td>
<td>It is recommended to leave this at the default. Is used to set the clock divider when configuring clocking from the internal reference clock</td>
</tr>
<tr><td>UART_TX_OVERSAMPLE</td>
<td>2</td>
<td>{1|2}</td>
<td>Define the oversampling of the clock - this is where the UART_TX_CLOCK_DIVIDER is &gt; 255 (otherwise set to 1) - only used when using an internal clock reference</td>
</tr>
<tr><td>UART_TX_BUF_SIZE</td>
<td>16</td>
<td>{1,2,4,8,16,32,...}</td>
<td>Define the buffer size in UART word entries - needs to be a power of 2 (i.e. 1,2,4,8,16,32)</td>
</tr>
<tr><td>UART_TX_CHAN_COUNT</td>
<td>8</td>
<td>{1,2,4,8}</td>
<td>Define the number of channels that are to be supported, must fit in the port. Also, must be a power of 2 (i.e. 1,2,4,8) - not all channels have to be utilised</td>
</tr>
<tr><td>UART_TX_IFB</td>
<td>0</td>
<td>{0..n}</td>
<td>Define the number of interframe bits - n should not make the total number of bits in a UART word exceed 32</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="static-configuration-of-uart-rx">
<h3>Static configuration of UART RX<a class="headerlink" href="#static-configuration-of-uart-rx" title="Permalink to this headline">¶</a></h3>
<p>Below is a summary of the configuration options that are in the <tt class="docutils literal"><span class="pre">multi_uart_rx_conf.h</span></tt> file, their suggested defaults and an explanation of their function.</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Define</th>
<th class="head">Default</th>
<th class="head">Other options</th>
<th class="head">Explanation</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>UART_RX_CHAN_COUNT</td>
<td>8</td>
<td>{1,2,4,8}</td>
<td>Define the number of channels that are to be supported, must fit in the port. Also, must be a power of 2 (i.e. 1,2,4,8) - not all channels have to be utilised</td>
</tr>
<tr><td>UART_RX_CLOCK_RATE_HZ</td>
<td>100000000</td>
<td>System reference clock rate</td>
<td>Defines the clock rate that the baud rates are derived from</td>
</tr>
<tr><td>UART_RX_MAX_BAUD</td>
<td>115200</td>
<td>less than or equal to 115200</td>
<td>Define the max baud rate the API will allow configuration. Validated to 115200.</td>
</tr>
<tr><td>UART_RX_CLOCK_DIVIDER</td>
<td>(UART_RX_CLOCK_RATE_HZ / UART_RX_MAX_BAUD)</td>
<td>Any appropriate divider</td>
<td>It is recommended to leave this at the default. Is used to set the clock divider when configuring clocking using either internal or external clocks.</td>
</tr>
<tr><td>UART_RX_OVERSAMPLE</td>
<td>4</td>
<td>Should remain at 4</td>
<td>Oversample count for the max baud rate. It is recommended to leave this value as it is unless it is understood the effects that changing this value will have.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="initialisation">
<span id="sec-initialisation"></span><h2>Initialisation<a class="headerlink" href="#initialisation" title="Permalink to this headline">¶</a></h2>
<p>The initialisation and configuration process for both the RX and TX operations is the same. For configuration the functions <a class="reference internal" href="API.html#uart_rx_initialise_channel" title="uart_rx_initialise_channel"><span>uart_rx_initialise_channel()</span></a> or <a class="reference internal" href="API.html#uart_tx_initialise_channel" title="uart_tx_initialise_channel"><span>uart_tx_initialise_channel()</span></a> is utilised. The flow is visualised in <a class="reference internal" href="#fig-uart-init-flow"><span>UART Initialisation Flow</span></a> and a working example taken from the echo test application that is utilised for verification.</p>
<div class="figure align-center" id="fig-uart-init-flow">
<img alt="_images/InitFlow.png" src="_images/InitFlow.png" style="width: 50%;" />
<p class="caption">UART Initialisation Flow</p>
</div>
<p>The following working example is taken from <cite>echo_test.c</cite> and shows a typical initial configuration.</p>
<div class="highlight-none"><div class="highlight"><pre>    /* configure UARTs */
    for (int i = 0; i &lt; 8; i++)
    {
        if ((int)baud_rate &lt;= 225)
            baud_rate = 225;
        
        if (uart_tx_initialise_channel( i, even, sb_1, start_0, baud_rate, 8 ))
        {
            printstr(&quot;Invalid baud rate for tx channel &quot;);
            printintln(i);
        }
        
        if (uart_rx_initialise_channel( i, even, sb_1, start_0, baud_rate, 8 ))
        {
            printstr(&quot;Invalid baud rate for rx channel &quot;);
            printintln(i);
        }
        
        printint(i); printstr(&quot; =&gt; &quot;); printint(baud_rate); printstr(&quot; bps 8-E-1\n&quot;);
    }
</pre></div>
</div>
<p>The next stage of initialisation is to release the server threads from their paused state. Upon start up their default state is to be paused until the following channel communication is completed.</p>
<div class="highlight-none"><div class="highlight"><pre>    /* release UART rx thread */
    do { temp = get_streaming_token(cRxBuf); } while (temp != MULTI_UART_GO);
    send_streaming_token(cRxBuf, 1);

    /* release UART tx thread */
    do { temp = get_streaming_token(cTxUART); } while (temp != MULTI_UART_GO);
    send_streaming_int(cTxUART, 1);
</pre></div>
</div>
<p>The above examples use the helper functions that are described in Multi-UART Helper API <a class="reference internal" href="API.html#sec-helper-api"><span>Multi-UART Helper API</span></a>. However, if operating within the XC language normal channel interaction can be utilised such as the example below (from the simple test program).</p>
<div class="highlight-none"><div class="highlight"><pre>    /* release UART rx thread */
    do { cUART :&gt; go; } while (go != MULTI_UART_GO);
    cUART &lt;: 1;
</pre></div>
</div>
</div>
<div class="section" id="interfacing-to-the-tx-server">
<span id="sec-interfacing-tx"></span><h2>Interfacing to the TX Server<a class="headerlink" href="#interfacing-to-the-tx-server" title="Permalink to this headline">¶</a></h2>
<p>To transmit data using the TX server the application should make use of <a class="reference internal" href="API.html#uart_tx_put_char" title="uart_tx_put_char"><span>uart_tx_put_char()</span></a>. An example use is shown below. This example, taken from the simple demo application configuration simply takes a string in the form of a character array and pushes it into the buffer one character at a time. When the API indicates that the buffer is full by returning a value of <cite>-1</cite> then the loop moves onto the next channel.</p>
<div class="highlight-none"><div class="highlight"><pre>       /* fill buffers with test strings */
       buffer_space = uart_tx_put_char(chan_id, 0xAA); //(unsigned int)test_str[chan_id][rd_ptr[chan_id]]);
       
       if (buffer_space != -1)
       {
           if (rd_ptr[chan_id] == 28)
               rd_ptr[chan_id] = 0;
           else
               rd_ptr[chan_id]++;
       }
       chan_id++;
       chan_id &amp;= UART_TX_CHAN_COUNT-1;
</pre></div>
</div>
<p>This operation must be completed on the same core as the TX server thread as the communication module utilises shared memory.</p>
</div>
<div class="section" id="interfacing-to-the-rx-server">
<span id="sec-interfacing-rx"></span><h2>Interfacing to the RX Server<a class="headerlink" href="#interfacing-to-the-rx-server" title="Permalink to this headline">¶</a></h2>
<p>To receive data from the RX server the application should make use of the channel that is provided. The channel provides notification to the application of which UART channel has data ready. The data itself is stored in a single storage slot with no buffering. This means that if the application layer fails to meet the timing requirements (as discussed in Client Timing <a class="reference internal" href="Resource Requirements.html#sec-client-timing"><span>Client Timing Requirements</span></a>) data may be lost and/or duplicated.</p>
<p>The echo test example implements an application level buffering for receiving data. This may or may not be required in a particular implementation - dependant on whether timing requirements can be met. The receive and processing loop is shown below.</p>
<div class="highlight-none"><div class="highlight"><pre>    while (1)
    {
        chan_id = (unsigned)get_streaming_token(cRxUART);
        
        /* get character over channel */
        uart_char = (unsigned)uart_rx_grab_char(chan_id);
        
        temp = uart_char;
        
        /* process received value */
        if ((rv = uart_rx_validate_char( chan_id, &amp;uart_char )) == 0)
        {
            if (rx_elements[chan_id] &lt; ECHO_BUF_SIZE)
            {
                rx_buffer[chan_id][rx_wr_ptr[chan_id]] = uart_char;
                rx_wr_ptr[chan_id]++;
                if (rx_wr_ptr[chan_id] &gt;= ECHO_BUF_SIZE)
                    rx_wr_ptr[chan_id] = 0;
                rx_elements[chan_id]++;
                
            } else printstr(&quot;RX Buf Full\n&quot;);
        }
        else { printstr(&quot;RX Validation fail\n\t0x&quot;); printhex(temp);printstr(&quot;\n\t&quot;);printintln(rv); }
    }
</pre></div>
</div>
<p>Once the token is received over the channel informing the application of the UART channel which has data ready the application uses the <a class="reference internal" href="API.html#uart_rx_grab_char" title="uart_rx_grab_char"><span>uart_rx_grab_char()</span></a> function to collect the data from the receive slot. This provides an unvalidated word. The application then utilises the <a class="reference internal" href="API.html#uart_rx_validate_char" title="uart_rx_validate_char"><span>uart_rx_validate_char()</span></a> to ensure that the UART word fits the requirements of the configuration (parity, stop bits etc) and provides the data upon return in the <tt class="docutils literal"><span class="pre">uart_char</span></tt> variable. This data is then inserted into a buffer.</p>
</div>
<div class="section" id="reconfiguration-of-rx-tx-server">
<span id="sec-reconf-rxtx"></span><h2>Reconfiguration of RX &amp; TX Server<a class="headerlink" href="#reconfiguration-of-rx-tx-server" title="Permalink to this headline">¶</a></h2>
<p>The method for reconfiguring the UART software is the same for both the RX and the TX servers. When the application requires a reconfiguration then a call to <a class="reference internal" href="API.html#uart_tx_reconf_pause" title="uart_tx_reconf_pause"><span>uart_tx_reconf_pause()</span></a> or <a class="reference internal" href="API.html#uart_rx_reconf_pause" title="uart_rx_reconf_pause"><span>uart_rx_reconf_pause()</span></a> needs to be made. When reconfiguring the RX side the server thread will pause immediately, however when pausing the TX side the server thread will pause the application thread to allow the buffers to empty in the TX thread.</p>
<p>Once the functions exit the server threads will be paused. Configuration is then done utilising the same methodology as initial configuration using a function such as the <a class="reference internal" href="API.html#uart_tx_initialise_channel" title="uart_tx_initialise_channel"><span>uart_tx_initialise_channel()</span></a> or <a class="reference internal" href="API.html#uart_rx_initialise_channel" title="uart_rx_initialise_channel"><span>uart_rx_initialise_channel()</span></a>.</p>
<p>Following the reconfiguration the application must then call <a class="reference internal" href="API.html#uart_tx_reconf_enable" title="uart_tx_reconf_enable"><span>uart_tx_reconf_enable()</span></a> and <a class="reference internal" href="API.html#uart_rx_reconf_enable" title="uart_rx_reconf_enable"><span>uart_rx_reconf_enable()</span></a> to re-enable the TX and RX threads respectively.</p>
<p>The listing below gives an example of reconfiguration that is taken from the echo test demonstration and test application.</p>
<div class="highlight-none"><div class="highlight"><pre>                    uart_tx_reconf_pause( cTxUART, t );
                    uart_rx_reconf_pause( cRxBuf );
                    
                    /* configure UARTs */
                    for (int i = 0; i &lt; 8; i++)
                    {
                        if ((int)baud_rate &lt;= 225)
                            baud_rate = 115200;
                        
                        if (uart_tx_initialise_channel( i, even, sb_1, baud_rate, 8 ))
                        {
                            printstr(&quot;Invalid baud rate for tx channel &quot;);
                            printintln(i);
                        }
                        
                        if (uart_rx_initialise_channel( i, even, sb_1, start_0, baud_rate, 8 ))
                        {
                            printstr(&quot;Invalid baud rate for rx channel &quot;);
                            printintln(i);
                        }
                        
                        printint(i); printstr(&quot; =&gt; &quot;); printint(baud_rate); printstr(&quot; bps 8-E-1\n&quot;);
                    }
                    
                    baud_rate /= 2;
                    
                    uart_tx_reconf_enable( cTxUART );
                    uart_rx_reconf_enable( cRxBuf );
</pre></div>
</div>
</div>
</div>



          </div>
        </div>
      </div>
      <div class="sphinxsidebar" id='d2'>
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Multi-UART Module Usage (0.1)</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Overview.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Resource Requirements.html">Resource Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="Hardware Requirements.html">Evaluation Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="Component Description.html">Component Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="API.html">Multi-UART Common API</a></li>
<li class="toctree-l1"><a class="reference internal" href="API.html#multi-uart-transmit-api">Multi-UART Transmit API</a></li>
<li class="toctree-l1"><a class="reference internal" href="API.html#multi-uart-receive-api">Multi-UART Receive API</a></li>
<li class="toctree-l1"><a class="reference internal" href="API.html#multi-uart-helper-api">Multi-UART Helper API</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Programming Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#structure">Structure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#source-code">Source Code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-of-multi-uart-component">Configuration of Multi-UART component</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#static-configuration-of-uart-tx">Static configuration of UART TX</a></li>
<li class="toctree-l3"><a class="reference internal" href="#static-configuration-of-uart-rx">Static configuration of UART RX</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#initialisation">Initialisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#interfacing-to-the-tx-server">Interfacing to the TX Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="#interfacing-to-the-rx-server">Interfacing to the RX Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reconfiguration-of-rx-tx-server">Reconfiguration of RX &amp; TX Server</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Example Applications.html">Example Applications</a></li>
</ul>

<div id="searchbox" style="display: none;margin-bottom: 10px;">
  <h3>Search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>



    <div class="footer">
    </div>
  </body>
</html>



